# Содержание
### [1) Терминология](#терминология)
### [2) Тестирование приложения “Интеграции” в условиях работы с актуальной бд](#тестирование-приложения-интеграции-в-условиях-работы-с-актуальной-бд)
### [3) Правила ведения изменений в бд при разработке модуля “интеграции” и “мат модель“ с активными правками в структуре](#правила-ведения-изменений-в-бд-при-разработке-модуля-интеграции-и-мат-модель-с-активными-правками-в-структуре)
### 4) Файл архитектуры проекта "Интеграции" находится в docs/backend/schemas/integration_arch.drawio

# Терминология
***Актуальная бд*** - бд, которая создаётся при запуске всех миграций в репозитории [ritm3](https://gitlab.satellite-soft.ru:2443/simmetra/ritm3) на момент принятия решения о структурном отрыве

***Слепок*** - это миграция, которая является отражением актуальной бд в рамках миграции питона

***Активная разработка*** - разработка в рамках которой начинается реализация масштабного логического блока. Например реализация новой методики для мат. модуля.

### Примечание
Важно обратить внимание на определение термина “[активная разработка](#активная-разработка---разработка-в-рамках-которой-начинается-реализация-масштабного-логического-блока-например-реализация-новой-методики-для-мат-модуля)” и не путать его с внесением небольших правок в типы данных таблиц или появлением нового поля. Если вы понимаете, что надо произвести правки в структуре бд, необходимо сразу попросить аналитика завести задачу под правки и согласовать её с тех. руководителем. 

___
# Тестирование приложения “Интеграции” в условиях работы с актуальной бд

Данный перечень действий необходимо выполнять для локального тестирования, чтобы не сбивать данные, используемые другими разработчиками.

1) Произвести клонирование [данного репозитория](https://gitlab.satellite-soft.ru:2443/simmetra/ritm3) 
2) Создать в директории [репозитория](https://gitlab.satellite-soft.ru:2443/simmetra/ritm3) **./backend** файл **.env** со следующим содержимым
```
APP_ENV=dev
APP_SECRET=f294b8e7cceb6db59dd7491f2c16ff37
DATABASE_URL=postgres://postgres:postgres@database:5432/devritm3
REDIS_HOST=redis
MESSENGER_TRANSPORT_DSN=redis://${REDIS_HOST}:${REDIS_PORT}/export_messages
INTEGRATION_URL=http://10.0.0.105:1337/api/dictionary
SYSDASH_URL=http://localhost:8080
SYSDASH_TOKEN=token
```
3) Открыть корневую директорию [репозитория](https://gitlab.satellite-soft.ru:2443/simmetra/ritm3) и ввести команду
```
docker-compose up –build -d
```

После чего развернется актуальная бд со следующими настройками:

- название бд = devritm3
- пароль = postgres
- имя пользователя = postgres
- порт = 5432
4) Далее необходимо накатить миграцию наполняющею бд минимальным перечнем данных для работы интеграционных команд. В терминале открываем корневую директорию бэкенда в проекте “Интеграции” (./components/backend) и запускаем команду 

````
python -m integration.composites.alembic_runner upgrade head
````

### Примечание
Так как бд в рамках докера настроена на запуск и работу внутри собственной сети, то если необходимо иметь возможность зайти в приложение, предназначенное для управления базами данных через интерфейс, необходимо выполнить следующий пункт

Перед выполнением пункта 2 необходимо зайти в файл docker-compose.yml и привести контейнер бд к следующему виду

![image](images/db_container.png)



# Правила ведения изменений в бд при разработке модуля “интеграции” и “мат модель“  с активными правками в структуре

Данный перечень действий предназначен для ведения активной разработки проекта интеграций и мат модели без потери информации об изменениях, которые были осуществлены в бд. Проблемой использования данного подхода является дублирование системных таблиц, которые использует мат модель, но интеграции они не нужны. А также таблицы, которые являются системными таблицами основного бэкенда, используемые в ссылках например “users”. 

Для явного разделения этих нюансов необходимо хранить сущности описанные выше в директории external_entities

![image](images/entities_dir.png)

1) Берём полностью протестированный проект интеграции, который работает с [актуальной бд](#актуальная-бд---бд-которая-создаётся-при-запуске-всех-миграций-в-репозитории-ritm3-на-момент-принятия-решения-о-структурном-отрыве)
2) Создаём пустую бд
3) Создаём миграцию питона для этой бд, которая и является [слепком](#слепок---это-миграция-которая-является-отражением-актуальной-бд-в-рамках-миграции-питона)
4) Накатываем миграцию на пустую бд
5) Каждое новое изменение фиксируем на уровне миграций и спокойно работаем, как на обычном проекте ([активная разработка](#активная-разработка---разработка-в-рамках-которой-начинается-реализация-масштабного-логического-блока-например-реализация-новой-методики-для-мат-модуля)). Узнать подробнее о правилах работы в данной фазе можно в [схемах](#схемы).
6) В момент завершения активной разработки мы чистим и откатываем все миграции кроме миграции, которая является [слепком](#слепок---это-миграция-которая-является-отражением-актуальной-бд-в-рамках-миграции-питона) на момент отрыва
7) После чего мы создаём ещё одну миграцию питона в рамках выполнения которой мы видим все нововведения, которые и являются различиями с основным бэкендом. 
8) На основе последней миграции необходимо сформировать файл с описанием отличий в бд. После создания файла мы согласовываем и утверждаем новые введения с основным бэкендом.
9) Завершающим действием будет удаление обеих миграций([слепок](#слепок---это-миграция-которая-является-отражением-актуальной-бд-в-рамках-миграции-питона) и миграция с изменениями), а также бд, которую мы использовали в активной разработке


# Схемы
Ветка **dev** - основная ветка разработки

Ветка **active_dev** - ветка в рамках которой производится [активная разработка](#активная-разработка---разработка-в-рамках-которой-начинается-реализация-масштабного-логического-блока-например-реализация-новой-методики-для-мат-модуля)


## Интеграция

![image](images/intr_gitflow.png)

(можно открыть схему в draw.io использую след файл - docs/backend/schemas/integration_gitflow.drawio)

1) Основная разработка. Выполняем во время обычной разработки. Наименование feature-[наименование функционала]
2) Функционал затрагивающий ядро. Изменения в директориях затрагивающих ядро, подробнее [тут](#будет ссылка на md с архитектурой интеграций). 
Наименование core-[наименование функционала]
3) Hot fix. Создаётся, когда мы работаем на ветке active_dev. 
Необходим для быстрых правок в системе с которой взаимодействуют остальные сервисы. 
Наименование hotfix-[наименование функционала]
4) Выполняем при переходе к [активной разработке](#активная-разработка---разработка-в-рамках-которой-начинается-реализация-масштабного-логического-блока-например-реализация-новой-методики-для-мат-модуля)
5) МРы, которые выполняем в рамках активной разработки. Наименование feature-[наименование функционала]
6) МРы, которые мы выполняем при возникновении изменений в ядре интеграций. 
Данный пункт выполняется для поддержания актуального состояния ядра в обеих ветках.
7) МРы, которые мы выполняем при возникновении багов в интеграциях.
8) Актуализируем dev после завершения всего [алгоритма](#правила-ведения-изменений-в-бд-при-разработке-модуля-интеграции-и-мат-модель-с-активными-правками-в-структуре) 
"[активной разработки](#активная-разработка---разработка-в-рамках-которой-начинается-реализация-масштабного-логического-блока-например-реализация-новой-методики-для-мат-модуля)".


## **Примечание**
Переход на ветку active_dev осуществляется одновременно для проекта “Интеграции” и “Математическая модель”. Таким образом мы сможем содержать оба сервиса в актуальном состоянии для внешнего мира и открытым для активного внесения правок не ожидая сторонние факторы.

Важно ответственно подходить к моментам начала фазы [активной разработки](#активная-разработка---разработка-в-рамках-которой-начинается-реализация-масштабного-логического-блока-например-реализация-новой-методики-для-мат-модуля) и её завершению.